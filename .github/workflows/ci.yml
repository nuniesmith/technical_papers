name: CI - LaTeX & Python

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:

jobs:
    test-python:
        name: üß™ Test Python Package
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.9", "3.10", "3.11", "3.12"]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e ".[dev]"

            - name: Run tests with coverage
              run: |
                  pytest --cov=project_janus --cov-report=xml --cov-report=term

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v5
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./coverage.xml
                  flags: python-${{ matrix.python-version }}
                  name: python-${{ matrix.python-version }}
                  fail_ci_if_error: false
                  verbose: true

    build-latex:
        name: üìÑ Build LaTeX PDFs
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install LaTeX dependencies
              run: |
                  sudo apt-get update -qq
                  sudo apt-get install -y -qq \
                    texlive-latex-base \
                    texlive-latex-extra \
                    texlive-fonts-extra \
                    texlive-science \
                    texlive-latex-recommended \
                    texlive-bibtex-extra \
                    biber

            - name: Find and compile all main LaTeX documents
              run: |
                  echo "üîç Finding LaTeX documents with \documentclass..."

                  # Find all .tex files containing \documentclass (main documents)
                  find . -name "*.tex" -type f ! -path "*/\.*" -exec grep -l "\\documentclass" {} \; > main_docs.txt

                  if [ ! -s main_docs.txt ]; then
                    echo "‚ùå No main LaTeX documents found"
                    exit 0
                  fi

                  echo "üìÑ Found $(wc -l < main_docs.txt) main document(s)"
                  cat main_docs.txt
                  echo ""

                  SUCCESS=0
                  FAIL=0

                  # Compile each document
                  while IFS= read -r tex_file; do
                    [ -z "$tex_file" ] && continue

                    dir=$(dirname "$tex_file")
                    base=$(basename "$tex_file" .tex)

                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "üìù Building: $tex_file"
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

                    cd "$dir" || continue

                    # Check if a .bib file exists (needs biber for bibliography)
                    HAS_BIB=false
                    if ls *.bib 1>/dev/null 2>&1; then
                      HAS_BIB=true
                      echo "üìö Bibliography file(s) detected ‚Äî will run biber"
                    fi

                    # Pass 1: Initial pdflatex (generates .aux/.bcf for biber)
                    if pdflatex -interaction=nonstopmode -halt-on-error "$base.tex"; then
                      echo "  ‚úì Pass 1/4: Initial compilation"
                    else
                      echo "‚ùå Failed: Compilation error on first pass"
                      FAIL=$((FAIL + 1))
                      cd - > /dev/null
                      echo ""
                      continue
                    fi

                    # Pass 2: Run biber if bibliography exists
                    if [ "$HAS_BIB" = true ] && [ -f "$base.bcf" ]; then
                      if biber "$base"; then
                        echo "  ‚úì Pass 2/4: Bibliography processed with biber"
                      else
                        echo "‚ö†Ô∏è  Biber failed ‚Äî continuing without resolved citations"
                      fi
                    else
                      echo "  ‚è≠ Pass 2/4: No bibliography ‚Äî skipping biber"
                    fi

                    # Pass 3: Resolve citations and back-references
                    if pdflatex -interaction=nonstopmode -halt-on-error "$base.tex"; then
                      echo "  ‚úì Pass 3/4: Citations resolved"
                    else
                      echo "‚ùå Failed: Compilation error on second pass"
                      FAIL=$((FAIL + 1))
                      cd - > /dev/null
                      echo ""
                      continue
                    fi

                    # Pass 4: Finalize cross-references and TOC
                    if pdflatex -interaction=nonstopmode -halt-on-error "$base.tex"; then
                      echo "  ‚úì Pass 4/4: Cross-references finalized"
                    else
                      echo "‚ùå Failed: Compilation error on third pass"
                      FAIL=$((FAIL + 1))
                      cd - > /dev/null
                      echo ""
                      continue
                    fi

                    if [ -f "$base.pdf" ]; then
                      size=$(du -h "$base.pdf" | cut -f1)
                      echo "‚úÖ Success: $base.pdf ($size)"
                      SUCCESS=$((SUCCESS + 1))
                    else
                      echo "‚ùå Failed: PDF not generated"
                      FAIL=$((FAIL + 1))
                    fi

                    # Clean auxiliary files (keep PDF)
                    rm -f *.aux *.log *.out *.toc *.synctex.gz *.fdb_latexmk *.fls \
                          *.bbl *.bcf *.blg *.run.xml 2>/dev/null

                    cd - > /dev/null
                    echo ""
                  done < main_docs.txt

                  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                  echo "üìä Build Summary: ‚úÖ $SUCCESS succeeded, ‚ùå $FAIL failed"
                  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

                  # Exit with error if any compilation failed
                  if [ $FAIL -gt 0 ]; then
                    echo "‚ùå Build failed: $FAIL document(s) failed to compile"
                    exit 1
                  fi

            - name: List generated PDFs
              run: |
                  echo "üì¶ Generated PDFs:"
                  find . -name "*.pdf" -type f ! -path "*/\.*" -exec ls -lh {} \;

            - name: Upload PDF artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: latex-pdfs
                  path: "**/*.pdf"
                  retention-days: 90

            - name: Commit PDFs to repository
              if: github.event_name == 'push' && github.ref == 'refs/heads/main'
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "GitHub Actions"

                  # Add all PDFs
                  find . -name "*.pdf" -type f ! -path "*/\.*" -exec git add -f {} \;

                  # Commit if there are changes
                  if git diff --staged --quiet; then
                    echo "‚ÑπÔ∏è  No PDF changes to commit"
                  else
                    git commit -m "ü§ñ Auto-compile LaTeX PDFs [skip ci]"
                    git push || echo "‚ö†Ô∏è  Push failed (possibly no changes)"
                  fi

            - name: Summary
              if: always()
              run: |
                  echo "# üìÑ LaTeX Build Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Download compiled PDFs from the artifacts section above ‚¨ÜÔ∏è" >> $GITHUB_STEP_SUMMARY

    ci-summary:
        name: üìä CI Summary
        runs-on: ubuntu-latest
        needs: [test-python, build-latex]
        if: always()

        steps:
            - name: Check job results
              run: |
                  echo "# üéâ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Python Tests | ${{ needs.test-python.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| LaTeX Build | ${{ needs.build-latex.result }} |" >> $GITHUB_STEP_SUMMARY

            - name: Fail if any job failed
              if: |
                  needs.test-python.result == 'failure' ||
                  needs.build-latex.result == 'failure'
              run: exit 1
