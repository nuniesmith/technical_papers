name: Build LaTeX Documents

on:
  push:
    branches:
      - main
    paths:
      - "**/*.tex"
      - "scripts/build.sh"
      - ".github/workflows/ci.yml"
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-latex:
    name: ðŸ“„ Build LaTeX PDFs
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install LaTeX dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-extra \
            texlive-science \
            texlive-latex-recommended \
            bc

      - name: Find all LaTeX documents
        id: find_tex
        run: |
          echo "Finding all .tex files that are main documents..."

          # Find all .tex files that contain \documentclass (main documents)
          main_docs=$(find . -name "*.tex" -type f ! -path "*/\.*" -exec grep -l "\\documentclass" {} \;)

          if [ -z "$main_docs" ]; then
            echo "No main LaTeX documents found"
            exit 0
          fi

          echo "Found main documents:"
          echo "$main_docs"

          # Save to output
          echo "$main_docs" > main_docs.txt

      - name: Compile all LaTeX documents
        run: |
          if [ ! -f main_docs.txt ]; then
            echo "No documents to compile"
            exit 0
          fi

          SUCCESS=0
          FAIL=0

          echo "## Build Results" > build-summary.md
          echo "" >> build-summary.md
          echo "| Document | Status | Size |" >> build-summary.md
          echo "|----------|--------|------|" >> build-summary.md

          while IFS= read -r tex_file; do
            if [ -z "$tex_file" ]; then
              continue
            fi

            # Get directory and filename without extension
            dir=$(dirname "$tex_file")
            base=$(basename "$tex_file" .tex)

            echo ""
            echo "======================================"
            echo "Building: $tex_file"
            echo "======================================"

            # Change to document directory
            cd "$dir" || continue

            # Compile twice for references and TOC
            if pdflatex -interaction=nonstopmode "$base.tex" > /dev/null 2>&1 && \
               pdflatex -interaction=nonstopmode "$base.tex" > /dev/null 2>&1; then

              if [ -f "$base.pdf" ]; then
                size=$(du -h "$base.pdf" | cut -f1)
                echo "âœ“ Successfully built $base.pdf ($size)"
                echo "| $tex_file | âœ… Success | $size |" >> "$OLDPWD/build-summary.md"
                ((SUCCESS++))
              else
                echo "âœ— PDF not generated for $base.tex"
                echo "| $tex_file | âŒ Failed (no PDF) | - |" >> "$OLDPWD/build-summary.md"
                ((FAIL++))
              fi
            else
              echo "âœ— Compilation failed for $base.tex"
              echo "| $tex_file | âŒ Failed (compile error) | - |" >> "$OLDPWD/build-summary.md"
              ((FAIL++))
            fi

            # Clean up auxiliary files
            rm -f *.aux *.log *.out *.toc *.synctex.gz *.fdb_latexmk *.fls 2>/dev/null

            # Return to root
            cd "$OLDPWD" || exit 1

          done < main_docs.txt

          echo ""
          echo "======================================"
          echo "Build Summary: $SUCCESS succeeded, $FAIL failed"
          echo "======================================"

          # Add summary footer
          echo "" >> build-summary.md
          echo "**Total:** $SUCCESS succeeded, $FAIL failed" >> build-summary.md

          cat build-summary.md

          # Exit with error if any builds failed
          if [ $FAIL -gt 0 ]; then
            exit 1
          fi

      - name: List all generated PDFs
        run: |
          echo "All generated PDFs:"
          find . -name "*.pdf" -type f ! -path "*/\.*" -exec ls -lh {} \;

      - name: Upload PDF artifacts
        uses: actions/upload-artifact@v4
        with:
          name: latex-pdfs-${{ github.sha }}
          path: "**/*.pdf"
          retention-days: 90

      - name: Upload build summary
        uses: actions/upload-artifact@v4
        with:
          name: build-summary
          path: build-summary.md
          retention-days: 30

      - name: Configure Git
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

      - name: Commit PDFs back to repository
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Find and add all PDFs
          find . -name "*.pdf" -type f ! -path "*/\.*" -exec git add {} \;

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No PDF changes to commit"
          else
            echo "Committing PDF changes..."
            git commit -m "Auto-compile LaTeX PDFs [skip ci]

            Built from commit: ${{ github.sha }}
            Workflow run: ${{ github.run_number }}"

            git push origin HEAD:main || {
              echo "Push failed. Retrying with force-lease..."
              git push --force-with-lease origin HEAD:main
            }

            echo "âœ“ PDFs committed successfully"
          fi

      - name: Create build summary
        if: always()
        run: |
          echo "# ðŸ“„ LaTeX Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f build-summary.md ]; then
            cat build-summary.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No build summary available" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Download compiled PDFs from the artifacts section above" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â„¹ï¸ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
