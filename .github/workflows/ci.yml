name: CI - LaTeX & Python

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:

jobs:
    python-lint-test:
        name: üêç Python Lint & Test
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.9", "3.10", "3.11", "3.12"]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .[dev]

            - name: Run Ruff linter
              run: |
                  ruff check project_janus/examples tests --output-format=github

            - name: Run Black formatter check
              run: |
                  black --check project_janus/examples tests

            - name: Run isort import check
              run: |
                  isort --check-only project_janus/examples tests

            - name: Run mypy type checker
              run: |
                  mypy project_janus/examples tests || true

            - name: Run pytest
              run: |
                  pytest -v --cov=project_janus --cov-report=xml --cov-report=term -m "not slow"

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              if: matrix.python-version == '3.11'
              with:
                  file: ./coverage.xml
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false

    python-test-full:
        name: üß™ Python Full Test Suite
        runs-on: ubuntu-latest
        needs: python-lint-test

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install all dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .[all,dev]

            - name: Run full test suite (including slow tests)
              run: |
                  pytest -v --cov=project_janus --cov-report=html

            - name: Upload test outputs as artifacts
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: test-outputs
                  path: |
                      htmlcov/
                      test_outputs_*/
                  retention-days: 7

    build-latex:
        name: üìÑ Build LaTeX PDFs
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install LaTeX dependencies
              run: |
                  sudo apt-get update -qq
                  sudo apt-get install -y -qq \
                    texlive-latex-base \
                    texlive-latex-extra \
                    texlive-fonts-extra \
                    texlive-science \
                    texlive-latex-recommended

            - name: Find and compile all main LaTeX documents
              run: |
                  echo "üîç Finding LaTeX documents with \documentclass..."

                  # Find all .tex files containing \documentclass (main documents)
                  find . -name "*.tex" -type f ! -path "*/\.*" -exec grep -l "\\documentclass" {} \; > main_docs.txt

                  if [ ! -s main_docs.txt ]; then
                    echo "‚ùå No main LaTeX documents found"
                    exit 0
                  fi

                  echo "üìÑ Found $(wc -l < main_docs.txt) main document(s)"
                  cat main_docs.txt
                  echo ""

                  SUCCESS=0
                  FAIL=0

                  # Compile each document
                  while IFS= read -r tex_file; do
                    [ -z "$tex_file" ] && continue

                    dir=$(dirname "$tex_file")
                    base=$(basename "$tex_file" .tex)

                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "üìù Building: $tex_file"
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

                    cd "$dir" || continue

                    # Compile twice for references/TOC
                    if pdflatex -interaction=nonstopmode -halt-on-error "$base.tex" && \
                       pdflatex -interaction=nonstopmode -halt-on-error "$base.tex"; then

                      if [ -f "$base.pdf" ]; then
                        size=$(du -h "$base.pdf" | cut -f1)
                        echo "‚úÖ Success: $base.pdf ($size)"
                        SUCCESS=$((SUCCESS + 1))
                      else
                        echo "‚ùå Failed: PDF not generated"
                        FAIL=$((FAIL + 1))
                      fi
                    else
                      echo "‚ùå Failed: Compilation error"
                      FAIL=$((FAIL + 1))
                    fi

                    # Clean auxiliary files
                    rm -f *.aux *.log *.out *.toc *.synctex.gz *.fdb_latexmk *.fls 2>/dev/null

                    cd - > /dev/null
                    echo ""
                  done < main_docs.txt

                  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                  echo "üìä Build Summary: ‚úÖ $SUCCESS succeeded, ‚ùå $FAIL failed"
                  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            - name: List generated PDFs
              run: |
                  echo "üì¶ Generated PDFs:"
                  find . -name "*.pdf" -type f ! -path "*/\.*" -exec ls -lh {} \;

            - name: Upload PDF artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: latex-pdfs
                  path: "**/*.pdf"
                  retention-days: 90

            - name: Commit PDFs to repository
              if: github.event_name == 'push' && github.ref == 'refs/heads/main'
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "GitHub Actions"

                  # Add all PDFs
                  find . -name "*.pdf" -type f ! -path "*/\.*" -exec git add -f {} \;

                  # Commit if there are changes
                  if git diff --staged --quiet; then
                    echo "‚ÑπÔ∏è  No PDF changes to commit"
                  else
                    git commit -m "ü§ñ Auto-compile LaTeX PDFs [skip ci]"
                    git push || echo "‚ö†Ô∏è  Push failed (possibly no changes)"
                  fi

            - name: Summary
              if: always()
              run: |
                  echo "# üìÑ LaTeX Build Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Download compiled PDFs from the artifacts section above ‚¨ÜÔ∏è" >> $GITHUB_STEP_SUMMARY

    ci-summary:
        name: üìä CI Summary
        runs-on: ubuntu-latest
        needs: [python-lint-test, python-test-full, build-latex]
        if: always()

        steps:
            - name: Check job results
              run: |
                  echo "# üéâ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Python Lint & Test | ${{ needs.python-lint-test.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Python Full Test | ${{ needs.python-test-full.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| LaTeX Build | ${{ needs.build-latex.result }} |" >> $GITHUB_STEP_SUMMARY

            - name: Fail if any job failed
              if: |
                  needs.python-lint-test.result == 'failure' ||
                  needs.python-test-full.result == 'failure' ||
                  needs.build-latex.result == 'failure'
              run: exit 1
